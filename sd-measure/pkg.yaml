name: sd-measure
dependencies:
  - stage: base
  - stage: coreutils
  - stage: gnuefi
  - stage: gperf
  - stage: libcap
  - stage: meson
    runtime: true
  - stage: openssl
  - stage: patch
    runtime: true
  - stage: pkg-config
    runtime: true
  - stage: python3
  - stage: tpm2-tss
  - stage: util-linux
steps:
  - sources:
      - url: https://github.com/systemd/systemd/archive/refs/tags/v{{ .systemd_version }}.tar.gz
        destination: systemd.tar.gz
        sha256: "{{ .systemd_sha256 }}"
        sha512: "{{ .systemd_sha512 }}"
    env:
      LD_LIBRARY_PATH: "/toolchain/lib"
      # https://github.com/openembedded/openembedded-core/blob/4d24749e7e94881bb952f5c927f0012eb70d4390/meta/recipes-core/systemd/systemd_253.3.bb#L117
      CFLAGS: "-D_LARGEFILE64_SOURCE -D__UAPI_DEF_ETHHDR=0"
      CPPFLAGS: "-D_LARGEFILE64_SOURCE -D__UAPI_DEF_ETHHDR=0"
      CXXFLAGS: "-D_LARGEFILE64_SOURCE -D__UAPI_DEF_ETHHDR=0"
    prepare:
      - |
        tar -xzf systemd.tar.gz --strip-components=1

        ln -s /toolchain/bin/echo /toolchain/bin/getent
        mkdir -p /usr/bin
        ln -sf /toolchain/bin/env /usr/bin/env
        ln -sf /toolchain/bin/python3 /toolchain/bin/python

        pip3 install jinja2 ninja

        # https://github.com/openembedded/openembedded-core/blob/4d24749e7e94881bb952f5c927f0012eb70d4390/meta/recipes-core/systemd/systemd_253.3.bb#L101
        patch -p1 < /pkg/patches/27254.patch
        patch -p1 < /pkg/patches/27253.patch

        # https://github.com/openembedded/openembedded-core/blob/4d24749e7e94881bb952f5c927f0012eb70d4390/meta/recipes-core/systemd/systemd_253.3.bb#L34
        patch -p1 < /pkg/patches/0009-missing_type.h-add-comparison_fn_t.patch
        patch -p1 < /pkg/patches/0010-add-fallback-parse_printf_format-implementation.patch
        patch -p1 < /pkg/patches/0011-src-basic-missing.h-check-for-missing-strndupa.patch
        patch -p1 < /pkg/patches/0012-don-t-fail-if-GLOB_BRACE-and-GLOB_ALTDIRFUNC-is-not-.patch
        patch -p1 < /pkg/patches/0013-add-missing-FTW_-macros-for-musl.patch
        patch -p1 < /pkg/patches/0014-Use-uintmax_t-for-handling-rlim_t.patch
        patch -p1 < /pkg/patches/0015-test-sizeof.c-Disable-tests-for-missing-typedefs-in-.patch
        patch -p1 < /pkg/patches/0016-don-t-pass-AT_SYMLINK_NOFOLLOW-flag-to-faccessat.patch
        patch -p1 < /pkg/patches/0017-Define-glibc-compatible-basename-for-non-glibc-syste.patch
        patch -p1 < /pkg/patches/0018-Do-not-disable-buffering-when-writing-to-oom_score_a.patch
        patch -p1 < /pkg/patches/0019-distinguish-XSI-compliant-strerror_r-from-GNU-specif.patch
        patch -p1 < /pkg/patches/0020-avoid-redefinition-of-prctl_mm_map-structure.patch
        patch -p1 < /pkg/patches/0021-do-not-disable-buffer-in-writing-files.patch
        patch -p1 < /pkg/patches/0022-Handle-__cpu_mask-usage.patch
        patch -p1 < /pkg/patches/0023-Handle-missing-gshadow.patch
        patch -p1 < /pkg/patches/0024-missing_syscall.h-Define-MIPS-ABI-defines-for-musl.patch
        patch -p1 < /pkg/patches/0005-pass-correct-parameters-to-getdents64.patch
        patch -p1 < /pkg/patches/0007-Add-sys-stat.h-for-S_IFDIR.patch
        patch -p1 < /pkg/patches/0001-Adjust-for-musl-headers.patch
        patch -p1 < /pkg/patches/0006-test-bus-error-strerror-is-assumed-to-be-GNU-specifi.patch
        patch -p1 < /pkg/patches/0003-errno-util-Make-STRERROR-portable-for-musl.patch

        # # https://github.com/openembedded/openembedded-core/blob/4d24749e7e94881bb952f5c927f0012eb70d4390/meta/recipes-core/systemd/systemd_253.3.bb#L101
        meson setup build \
          --buildtype=release \
          -Dmode=release \
          -Dsbat-distro=talos \
          -Dsbat-distro-summary="Talos Linux" \
          -Dsbat-distro-url=https://github.com/siderolabs/tools/issues \
          -Dman=false \
          -Defi=true \
          -Dgnu-efi=true \
          -Defi-libdir=/toolchain/lib \
          -Defi-includedir=/toolchain/include/efi \
          -Dtpm2=true \
          -Dgshadow=false \
          -Didn=false \
          -Dlocaled=false \
          -Dnss-mymachines=false \
          -Dnss-resolve=false \
          -Dsysusers=false \
          -Duserdb=false \
          -Dutmp=false
    build:
      - |
        # might as well copy ukify here
        ninja -j $(nproc) -C build systemd-measure ukify
    install:
      - |
        mkdir -p /rootfs/toolchain/{bin,lib}

        cp build/systemd-measure /rootfs/toolchain/bin
        cp build/ukify /rootfs/toolchain/bin
        cp build/src/shared/libsystemd-shared-{{ .systemd_version }}.so /rootfs/toolchain/lib
finalize:
  - from: /rootfs
    to: /
