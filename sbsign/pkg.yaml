name: sbsign
dependencies:
  - stage: base
  - stage: make
  - stage: autoconf
  - stage: automake
  - stage: pkg-config
    runtime: true
  - stage: gnuefi
  - stage: openssl
  - stage: util-linux
steps:
  - sources:
      - url: https://git.ozlabs.org/?p=ccan;a=snapshot;h=b1f28e17227f2320d07fe052a8a48942fe17caa5;sf=tgz
        destination: ccan.tar.gz
        sha256: "{{ .ccan_sha256 }}"
        sha512: "{{ .ccan_sha512 }}"
      - url: https://git.kernel.org/pub/scm/linux/kernel/git/jejb/sbsigntools.git/snapshot/sbsigntools-{{ .sbsign_version }}.tar.gz
        destination: sbsign.tar.gz
        sha256: "{{ .sbsign_sha256 }}"
        sha512: "{{ .sbsign_sha512 }}"
    prepare:
      - |
        tar -xf sbsign.tar.gz --strip-components=1

        rm -rf lib/ccan.git
        mkdir -p lib/ccan.git
        tar xf ccan.tar.gz --strip-components=1 -C lib/ccan.git

        # disable docs
        sed -i 's/docs//g' Makefile.am
        # overwrite hardcoded `/lib` to be `/toolchain/lib` so it can find gnuefi objects
        sed -i 's/for path in \/lib/for path in \/toolchain\/lib/g' configure.ac

        ./autogen.sh

        ./configure \
          --prefix=${TOOLCHAIN}
    build:
      - |
        make -j $(nproc)
    install:
      - |
        mkdir -p /rootfs

        make DESTDIR=/rootfs install
finalize:
  - from: /rootfs
    to: /
